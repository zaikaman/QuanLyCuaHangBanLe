@model IEnumerable<QuanLyCuaHangBanLe.Models.Promotion>

@{
    ViewData["Title"] = "Qu·∫£n l√Ω khuy·∫øn m√£i";
}

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .btn-primary {
        padding: 12px 24px;
        background: #4E5FFF;
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        background: #4E5FFF;
        color: white;
    }

    .promotions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
    }

    .promo-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #1a1a1a;
        transition: all 0.3s ease;
    }

    .promo-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .promo-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
    }

    .promo-code {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1a1a1a;
        font-family: 'Courier New', monospace;
    }

    .promo-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .promo-status.active {
        background: #c6f6d5;
        color: #22543d;
    }

    .promo-status.inactive {
        background: #fed7d7;
        color: #742a2a;
    }

    .promo-description {
        color: #4a5568;
        margin-bottom: 15px;
        font-size: 0.95rem;
    }

    .promo-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 15px;
    }

    .promo-detail {
        padding: 10px;
        background: #f7fafc;
        border-radius: 8px;
    }

    .promo-detail-label {
        font-size: 0.75rem;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .promo-detail-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
    }

    .promo-progress {
        margin-top: 15px;
    }

    .promo-progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #718096;
        margin-bottom: 8px;
    }

    .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: #4E5FFF;
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .promo-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }

    .btn-action {
        flex: 1;
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        text-align: center;
    }

    .btn-delete {
        background: #fed7d7 !important;
        color: #c53030 !important;
        border: 2px solid transparent !important;
    }

    .btn-delete:hover {
        background: #ffffff !important;
        border: 2px solid #c53030 !important;
        color: #c53030 !important;
    }
</style>

<div class="page-header">
    <div>
        <h1>üéÅ Qu·∫£n l√Ω khuy·∫øn m√£i</h1>
        <p style="color: #718096; margin-top: 5px;">T·∫°o v√† qu·∫£n l√Ω ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i</p>
    </div>
    <a asp-action="Create" class="btn-primary">
        <i class="fas fa-plus"></i>
        T·∫°o khuy·∫øn m√£i m·ªõi
    </a>
</div>

<div class="promotions-header" style="padding: 20px 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <form asp-action="Index" method="get" style="margin: 0; flex: 1;">
        <input type="text" name="searchTerm" class="search-input" placeholder="üîç T√¨m ki·∫øm khuy·∫øn m√£i..." value="@ViewBag.SearchTerm" style="padding: 10px 15px; border: 1px solid #e5e5e5; border-radius: 8px; width: 400px; font-size: 0.9rem; background: #fafafa;" />
        <input type="hidden" name="page" value="1" />
    </form>
    <div style="color: #718096; font-size: 0.9rem;">
        T·ªïng: <strong style="color: #2d3748;">@ViewBag.TotalItems</strong> khuy·∫øn m√£i
    </div>
</div>

@if (Model.Any())
{
    <div class="promotions-grid">
        @foreach (var promo in Model)
        {
            var usagePercent = promo.UsageLimit > 0 ? (promo.UsedCount * 100.0 / promo.UsageLimit) : 0;
            
            <div class="promo-card">
                <div class="promo-header">
                    <div class="promo-code">@promo.PromoCode</div>
                    <span class="promo-status @promo.Status">
                        @(promo.Status == "active" ? "ƒêang ho·∫°t ƒë·ªông" : "Kh√¥ng ho·∫°t ƒë·ªông")
                    </span>
                </div>

                <div class="promo-description">
                    @promo.Description
                </div>

                <div class="promo-details">
                    <div class="promo-detail">
                        <div class="promo-detail-label">Gi·∫£m gi√°</div>
                        <div class="promo-detail-value">
                            @if (promo.DiscountType == "percent")
                            {
                                <span>@promo.DiscountValue%</span>
                            }
                            else
                            {
                                <span>@promo.DiscountValue.ToString("N0")ƒë</span>
                            }
                        </div>
                    </div>
                    <div class="promo-detail">
                        <div class="promo-detail-label">ƒê∆°n t·ªëi thi·ªÉu</div>
                        <div class="promo-detail-value">@promo.MinOrderAmount.ToString("N0")ƒë</div>
                    </div>
                </div>

                <div class="promo-detail" style="grid-column: 1 / -1;">
                    <div class="promo-detail-label">Th·ªùi gian</div>
                    <div class="promo-detail-value" style="font-size: 0.9rem;">
                        @promo.StartDate.ToString("dd/MM/yyyy") - @promo.EndDate.ToString("dd/MM/yyyy")
                    </div>
                </div>

                <div class="promo-progress">
                    <div class="promo-progress-label">
                        <span>ƒê√£ s·ª≠ d·ª•ng</span>
                        <span><strong>@promo.UsedCount</strong> / @promo.UsageLimit</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @usagePercent%"></div>
                    </div>
                </div>

                <div class="promo-actions">
                    <a asp-action="Details" asp-route-id="@promo.PromoId" 
                       class="btn-action">
                        üëÅÔ∏è Xem
                    </a>
                    <a asp-action="Edit" asp-route-id="@promo.PromoId" 
                       class="btn-action">
                        ‚úèÔ∏è S·ª≠a
                    </a>
                    <button type="button" 
                            class="btn-action btn-delete" 
                            onclick="deletePromotion(@promo.PromoId, '@promo.PromoCode')">
                        üóëÔ∏è X√≥a
                    </button>
                </div>
            </div>
        }
    </div>
}
else
{
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
        <div style="font-size: 4rem; margin-bottom: 20px;">üéÅ</div>
        <div style="color: #a0aec0;">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i n√†o</div>
    </div>
}

@if (ViewBag.TotalPages != null && ViewBag.TotalPages > 1)
{
    <div class="pagination-container" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; padding: 20px;">
        @if (ViewBag.CurrentPage > 1)
        {
            <a asp-action="Index" asp-route-page="@(ViewBag.CurrentPage - 1)" asp-route-searchTerm="@ViewBag.SearchTerm" class="pagination-btn" style="padding: 10px 16px; background: #4E5FFF; color: white; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s;">‚Üê Tr∆∞·ªõc</a>
        }
        
        <div style="display: flex; gap: 5px;">
            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                if (i == ViewBag.CurrentPage)
                {
                    <span class="pagination-current" style="padding: 10px 16px; background: #4E5FFF; color: white; border-radius: 8px; font-weight: 600;">@i</span>
                }
                else if (i == 1 || i == ViewBag.TotalPages || (i >= ViewBag.CurrentPage - 2 && i <= ViewBag.CurrentPage + 2))
                {
                    <a asp-action="Index" asp-route-page="@i" asp-route-searchTerm="@ViewBag.SearchTerm" style="padding: 10px 16px; background: #f5f5f5; color: #1a1a1a; border-radius: 8px; text-decoration: none; transition: all 0.3s;">@i</a>
                }
                else if (i == ViewBag.CurrentPage - 3 || i == ViewBag.CurrentPage + 3)
                {
                    <span style="padding: 10px 16px;">...</span>
                }
            }
        </div>
        
        @if (ViewBag.CurrentPage < ViewBag.TotalPages)
        {
            <a asp-action="Index" asp-route-page="@(ViewBag.CurrentPage + 1)" asp-route-searchTerm="@ViewBag.SearchTerm" class="pagination-btn" style="padding: 10px 16px; background: #4E5FFF; color: white; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s;">Sau ‚Üí</a>
        }
    </div>
}

<script>
    // Auto-submit search form khi g√µ (v·ªõi debounce)
    let searchTimeout;
    document.querySelector('.search-input')?.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            e.target.closest('form').submit();
        }, 500); // ƒê·ª£i 500ms sau khi ng∆∞·ªùi d√πng ng·ª´ng g√µ
    });

    // Delete promotion function
    async function deletePromotion(id, promoCode) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a khuy·∫øn m√£i "${promoCode}" kh√¥ng?`)) {
            return;
        }

        try {
            // Get anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            
            const formData = new FormData();
            formData.append('id', id);
            if (token) {
                formData.append('__RequestVerificationToken', token.value);
            }

            const response = await fetch('@Url.Action("Delete", "Promotions")', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert(result.message);
                location.reload(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
            } else {
                alert('L·ªói: ' + result.message);
            }
        } catch (error) {
            alert('L·ªói khi x√≥a: ' + error.message);
        }
    }
</script>
